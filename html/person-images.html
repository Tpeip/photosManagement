<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<style>
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			
			.mui-preview-loading.mui-active {
				display: block;
			}
			
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
			
				100% {
					opacity: 1;
				}
			}
			
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
			
				100% {
					opacity: 1;
				}
			}
			
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
			
				100% {
					opacity: 0;
				}
			}
			
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
			
				100% {
					opacity: 0;
				}
			}
			.mui-content{
				margin-top:30px;
			}
			.img-face{
				width: 120px;
				height: 120px;
				border-radius: 10px;
			}
			.label-person{
				margin-top: 35px;
			}
			.label-person > a{
				font-size: 28px;
			}
			.label-person > p{
				font-size: 16px;
				margin-top: 5px;
			}
			.iconfont{
				font-size: 24px;
			}
			.mui-content-padded{
				margin: 0;
				margin-left: 2px;
				padding: 0;
			}
			.mui-ellipsis{
				margin: 20px 0 10px 20px;
				padding-bottom: 8px;
				font-size: 16px;
			}
			.image-border {
				width: 49.4%;
				height: 180px;
				display: inline-block;
				margin-right: 2px;
				margin-top: -8px;
				/* margin: 0px;
				margin-right: -3px;
				margin-top: -3px;
				padding: 0px; */
			}			
			.images {
				width: 100%;
				height: 100%;
				object-fit: cover;
			.mui-color{
				background-color: white;
			}
			.hidden{
				display: none;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		</header>
		<div class="mui-content">
			<div id="top" class="mui-row">
				<!-- <div  class="mui-media mui-col-xs-5" style="left:20px;">
					<img class="img-face" src="  images/14.jpg" />
				</div>
				<div class="mui-media mui-col-xs-7">
					<div class="label-person">
						<a id="showPerson" onclick="chooseText()">这是谁&nbsp;<span class="iconfont icon-write"></span></a>
						<p>16张照片</p>
					</div>
				</div> -->
			</div>
			<div id="bottom" class="mui-content-padded">
				<!-- <p class="mui-ellipsis">相关照片</p>
				<p class="image-border">
					<img class="images" src="  images/people.jpg" data-preview-src="" data-preview-group="1" />
				</p>
				<p class="image-border">
					<img class="images" src="  images/yuantiao.jpg" data-preview-src="" data-preview-group="1" />
				</p>
				<p class="image-border">
					<img class="images" src="  images/people.jpg" data-preview-src="" data-preview-group="1" />
				</p>
				<p class="image-border">
					<img class="images" src="  images/yuantiao.jpg" data-preview-src="" data-preview-group="1" />
				</p>
				<p class="image-border">
					<img class="images" src="  images/yuantiao.jpg" data-preview-src="" data-preview-group="1" />
				</p>
				<p class="image-border">
					<img class="images" src="  images/yuantiao.jpg" data-preview-src="" data-preview-group="1" />
				</p> -->
			</div>

		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="../js/mui.zoom.js"></script>
		<script type="text/javascript" src="../js/mui.imageViewer.js"></script>
		<script src="../js/mui.previewimage3.js"></script>
		<script src="../js/websql.js"></script>
		<script src="../js/person.js"></script>
		<script type="text/javascript">
			mui.init({
				beforeback: function() {
					//获得父页面的webview
					var listpage = plus.webview.currentWebview().opener();
					//触发父页面的自定义事件(refresh),从而进行刷新
					mui.fire(listpage, 'fresh');
					// 					var list = plus.webview.currentWebview().opener();
					// 					mui.fire(list, 'fresh');
					//返回true,继续页面关闭逻辑
					return true;
				}
			});
			var person_id = localStorage.getItem('id');

			// mui.plusReady(function() {
			getFace();
			getImages();
			// })
			// 			mui.init();
			// 			document.getElementById('backing').addEventListener('tap', function() {
			// 				plus.webview.currentWebview().close();				
			// 			});



			//获取当前页面的人脸
			function getFace() {
				var person_id = localStorage.getItem('id');
				console.log(person_id);
				getOnePerson(person_id).then(function(e) {
					var person_name = e.rows.item(0).person_name;
					var person_age = e.rows.item(0).age;
					var person_gender = e.rows.item(0).gender;
					var person_ethnicity = e.rows.item(0).ethnicity;
					var person_beauty = e.rows.item(0).beauty;
					getFaceByPerson(person_id).then(function(res) {
						var face_src = res.rows.item(0).face_src;
						var image_num = res.rows.length;
						if (person_name == '未命名') {
							person_name = '这是谁';
						}
						setTopHtml(face_src, person_name, image_num, person_age, person_gender, person_ethnicity, person_beauty);
					});
				}).catch(function(e) {
					console.log(JSON.stringify(e));
				});
			}

			//获取该人物的所有照片并显示
			function getImages() {
				var person_id = localStorage.getItem('id');
				jQuery('#bottom').empty();
				getFaceByPerson(person_id).then(function(e) {
					var bottom_html = '<p class="mui-ellipsis">相关照片</p>';
					for (let i = 0; i < e.rows.length; i++) {
						var image_path = e.rows.item(i).image_path;
						var html = '<p class="image-border">' +
							'<img id="' + image_path + '" class="images" src="' + image_path +
							'" data-preview-src="" data-preview-group="1" />' +
							'</p>';
						bottom_html += html;
					}
					jQuery('#bottom').append(bottom_html);
				})
			}

			//显示顶部人脸及文字
			function setTopHtml(face_src, person_name, image_num, person_age, person_gender, person_ethnicity, person_beauty,
				person_emotion) {
				jQuery('#top').empty();
				var html = '<div  class="mui-media mui-col-xs-5" style="left:20px;">' +
					'<img class="img-face" src="' + face_src + '" />' +
					'</div>' +
					'<div class="mui-media mui-col-xs-7">' +
					'<div class="label-person">' +
					'<a id="showPerson" onclick="modifyPersonInfo(\'' + person_name + '\',\'' + person_age + '\',\'' + person_gender +
					'\',\'' + person_ethnicity + '\',\'' + person_beauty + '\',\'' + person_emotion + '\')">' + person_name +
					'&nbsp;<span class="iconfont icon-write"></span></a>' +
					'<p>' + image_num + '张照片</p>' +
					'</div>' +
					'</div>';
				jQuery('#top').append(html);
			}

			//修改人物姓名
			function modifyPersonInfo(name, age, gender, ethnicity, beauty, emotion) {
				// e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
				var btnArray = ['取消', '确定'];
				let gender_html =
					'<div style="font-size:16px;">性别：<label ><input id="gender" type="radio" name="gender" value="男" style="margin-left:5px;width:30px" checked>男性' +
					'</label>&nbsp;&nbsp;<input type="radio" name="gender" style="width:30px;" value="女">女性</div><br/>';
				if (gender == '男') {
					gender_html =
						'<div style="font-size:16px;">性别：<label ><input id="gender" type="radio" name="gender" value="男" style="margin-left:5px;width:30px" checked>男性' +
						'</label>&nbsp;&nbsp;<input type="radio" name="gender" style="width:30px;" value="女">女性</div><br/>';
				} else {
					gender_html =
						'<div style="font-size:16px;">性别：<label ><input id="gender" type="radio" name="gender" value="男" style="margin-left:5px;width:30px">男性' +
						'</label>&nbsp;&nbsp;<input type="radio" name="gender" style="width:30px;" value="女" checked>女性</div><br/>'
				}
				let ethnicity_html =
					'<div style="font-size:16px;margin-top:-10px">种族：<select id="ethnic" style="height:35px;width:134px;"><option value="黄种" selected="selected">黄种' +
					'</option><option value="白种">白种</option><option value="黑种">' +
					'黑种</option><option value="印度">印度</option></select></div>';
				if (ethnicity === '白种') {
					ethnicity_html =
						'<div style="font-size:16px;margin-top:-10px">种族：<select id="ethnic" style="height:35px;width:134px;"><option value="黄种">黄种' +
						'</option><option value="白种"  selected="selected">白种</option><option value="黑种">' +
						'黑种</option><option value="印度">印度</option></select></div>';
				} else if (ethnicity === '黑种') {
					ethnicity_html =
						'<div style="font-size:16px;margin-top:-10px">种族：<select id="ethnic" style="height:35px;width:134px;"><option value="黄种">黄种' +
						'</option><option value="白种">白种</option><option value="黑种"  selected="selected">' +
						'黑种</option><option value="印度">印度</option></select></div>';
				} else if (ethnicity === '印度') {
					ethnicity_html =
						'<div style="font-size:16px;margin-top:-10px">种族：<select id="ethnic" style="height:35px;width:134px;"><option value="黄种">黄种' +
						'</option><option value="白种">白种</option><option value="黑种">' +
						'黑种</option><option value="印度"  selected="selected">印度</option></select></div>';
				} else {
					ethnicity_html =
						'<div style="font-size:16px;margin-top:-10px">种族：<select id="ethnic" style="height:35px;width:134px;"><option value="黄种" selected="selected">黄种' +
						'</option><option value="白种">白种</option><option value="黑种">' +
						'黑种</option><option value="印度">印度</option></select></div>';
				}
				var btnArray = ['取消', '确定'];
				var html =
					'<br><div style="font-size:16px">姓名：<input id="name" type="text" autofocus="autofocus" value="" placeholder="' +
					name + '" style="height:25px;width:134px"></div>' +
					'<div style="font-size:16px">年龄：<input id="age" type="text" value="" placeholder="' + age +
					'" style="height:25px;width:134px"></div>' + gender_html + ethnicity_html +
					'<div style="font-size:16px">颜值：<input id="beauty" type="text" value="' + beauty +
					'" readonly style="height:25px;width:134px"></div>';
				mui.confirm(html, '信息修改', btnArray, function(e) {
					// $("#gender").prop("checked",true);
					if (e.index == 1) {
						var person_name = name;
						var person_age = age;
						var name_value = $("#name").val();
						var age_value = $("#age").val();
						var person_gender = $("input:radio:checked").val();
						var person_ethnicity = $("select#ethnic option:selected").val();
						if (name_value == "" || name_value == null) {
							person_name = name;
						} else {
							person_name = name_value;
						}
						if (age_value == "" || age_value == null) {
							person_age = age;
						} else {
							person_age = age_value;
						}
						UpdateToName(id, person_name).then(function() {
							UpdatePersonInfo(id, person_age, person_gender, person_ethnicity).then(function(){
								UpdateFaceInfo(id, person_age, person_gender, person_ethnicity);
							});							
						});
						setTopHtml();
					}
				}, 'div');
			}

			mui.previewImage(function(img) {
				plus.webview.currentWebview().setStyle({
					top: '0px',
					bottom: '0px'
				})
			}, function(img) {
				plus.webview.currentWebview().setStyle({
					top: '0px',
					bottom: '0px'
				});
			});
		</script>
	</body>

</html>
