<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			img {
				height: 70px;
				width: 70px;
				border-radius: 70px;
				margin-right: 3px;
			}

			#slider {
				height: 70px;
			}

			.mui-content-padded {
				margin-top: 20px;
			}

			.label-font {
				font-size: 16px;
				color: #6D6D72;
			}

			.icon-style {
				font-size: 20px;
				color: #0062CC;
				font-weight: bolder;
			}
		</style>
	</head>
	<body>
		<div class="mui-content">
			<img id="img" style="display:none" />
			<canvas id="can" style="display:none;width:200px;height:200px"></canvas>
			<div class="mui-content-padded">
				<div id="slider" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div id="img-faces" class="mui-scroll">
						<!-- <img src="images/12.png" onclick="turnTo()" />
						<img src="images/13.png" />
						<img src="images/14.jpg" />
						<img src="images/15.jpg" />
						<img src="images/12.png" />
						<img src="images/13.png" />
						<img src="images/14.jpg" />
						<img src="images/15.jpg" />
						<img id="more" src="images/more.png" /> -->
					</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<label class="mui-icon mui-icon-paperplane icon-style"></label>
				<label class="mui-tab-label label-font">人脉关系图</label>
				<a id="modify" class="mui-tab-label label-font mui-pull-right" style="color: #0062CC;">修改</a>
				<div id="demo1" style="height:500px;border-top:1px solid #ccc;margin-top:10px"></div>
			</div>
		</div>

	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/jquery.min.js"></script>
	<script src="../js/esl.js"></script>
	<script src="../js/websql.js"></script>
	<script type="text/javascript">
		// 			mui.init();
		// 			mui('#slider').scroll({
		// 				indicators: true
		// 			});
		var relations = ['朋友', '同学', '同事', '兄弟', '姐妹', '家人', '父母', '孩子', '爱人'];

		mui.plusReady(function() {
			//				getPersonGroup();
			// updateGroupFace();
			setFaceHtml();
		})
		
		var flag = 0;
		localStorage.setItem('mod',flag);
		document.getElementById('modify').addEventListener('tap',function(){
			if(flag == 0){
				document.getElementById('modify').innerHTML = '取消修改';
				flag = 1;
				localStorage.setItem('mod',flag);
			}
			else{
				document.getElementById('modify').innerHTML = '修改';
				flag = 0;
				localStorage.setItem('mod',flag);
			}
		})



		//显示人物分组
		function setFaceHtml() {
			var html = '';
			getGroupFace().then(function(e) {
				// console.log(e.rows.length);
				// console.log(e.rows.item(0));
				var length = e.rows.length;
				// 						if (e.rows.length > 7) {
				// 							length = 7;
				// 						}
				for (let i = 0; i < length; i++) {
					let face_url = e.rows.item(i).face_src;
					let group_id = e.rows.item(i).group_id;
					// console.log(group_id);
					// console.log(face_url);
					var face_html = '<img src="' + face_url + '" onclick="turnTo(\'' + group_id + '\')" />'
					html += face_html;
				}
				html = html + '<img id="more" src="../images/more.png"  onclick="showPersons()"/>';
				jQuery('#img-faces').append(html);
			}).catch(function(e) {
				console.log(e);
			});

		}



		function turnTo(group_id) {
			// localStorage.setItem('id', group_id);
			// 			mui.openWindow({
			// 				url: 'person-images.html',
			// 				show: {
			// 					autoShow: true,
			// 					aniShow: 'slide-in-right',
			// 					duration: 300
			// 				}
			// 			});
			getPersonRelation(group_id);
		}

		function showPersons() {
			mui.openWindow({
				url: 'persons.html',
				show: {
					autoShow: true,
					aniShow: 'slide-in-right',
					duration: 300
				}
			});
		}

		function getPersonRelation(group_id) {
			localStorage.setItem('id', group_id);
			getPersonIntimacy(group_id);
			// 			handleCorePerson(group_id);
			relationGraph(group_id);
		}

        //通过照片数量的比例获取亲密度
		function getPersonIntimacy(group_id) {
			var promiseArr = [];
			let persons_intimacy = {};
			getFaceByGroup(group_id).then(function(e) {
				var image_num = e.rows.length;
				for (let i = 0; i < e.rows.length; i++) {
					let image_path = e.rows.item(i).image_path;
					promiseArr.push(
						getPersonImage(image_path).then(function(res) {
							for (let j = 0; j < res.rows.length; j++) {
								let id = res.rows.item(j).group_id;
								if (id != group_id) {
									if (persons_intimacy != null) {
										if (persons_intimacy.hasOwnProperty(id)) {
											persons_intimacy[id] = persons_intimacy[id] + 1;
										} else {
											persons_intimacy[id] = 1;
											// persons_intimacy.id.value = 1;
										}
									} else {
										persons_intimacy[id] = 1;
									}
								}
							}
						}).catch(function(error) {
							console.log(error);
						}))
				}
				Promise.all(promiseArr).then(function() {
					// console.log(JSON.stringify(persons_intimacy));
					for (let id in persons_intimacy) {
						persons_intimacy['' + id + ''] = parseInt(persons_intimacy['' + id + ''] / image_num * 100);
						// console.log(persons_intimacy[''+ id +'']);
					}
					// console.log(JSON.stringify(persons_intimacy));
					handleCorePerson(persons_intimacy, group_id);
				})
			}).catch(function(err) {
				console.log(err);
			})
		}

		//处理核心人物所有照片中的人脉关系
		function handleCorePerson(persons_intimacy, group_id) {
			getFaceByGroup(group_id).then(function(e) {
				var image_num = e.rows.length;
				for (let i = 0; i < e.rows.length; i++) {
					let image_path = e.rows.item(i).image_path;
					handleOneImage(persons_intimacy, image_path, group_id);
				}
			}).catch(function(err) {
				console.log(err);
			})
		}

		//获取一张照片中核心人物与相关人物间的关系
		function handleOneImage(persons_intimacy, image_path, group_id) {
			getPersonImage(image_path).then(function(res) {
				let person_core;
				let persons_main = [];
				for (let j = 0; j < res.rows.length; j++) {
					let person_core_id = res.rows.item(j).group_id;
					if (person_core_id == group_id) {
						person_core = {
							'group_id': person_core_id,
							'age': res.rows.item(j).age,
							'gender': res.rows.item(j).gender
						}
					} else {
						person_main = {
							'age': res.rows.item(j).age,
							'gender': res.rows.item(j).gender,
							'group_id': person_core_id,
							'face_src': res.rows.item(j).face_src
						}
						persons_main.push(person_main);
					}
				}
				for (let i = 0; i < persons_main.length; i++) {
					let persons_num = persons_main.length;
					let id = persons_main[i].group_id;
					getOneRelation(person_core.group_id, id).then(function(e) {
						if (e.rows.length == 0) {
							// if(persons_num == 1){
							if (persons_main[i].gender != person_core.gender) {
								if (person_core.age > 20) {
									if (Math.abs(persons_main[i].age - person_core.age) <= 10) {
										if (persons_intimacy[id] >= 60) {
											InsertToRelation(person_core.group_id, id, relations[8], persons_intimacy[id]);
										} else if (persons_intimacy[id] >= 20 && persons_intimacy[id] < 60) {
											InsertToRelation(person_core.group_id, id, relations[2], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else if (Math.abs(persons_main[i].age - person_core.age) > 10 && Math.abs(persons_main[i].age -
											person_core.age) <=25 ) {
										if (persons_intimacy[id] >= 50) {
											InsertToRelation(person_core.group_id, id, relations[5], persons_intimacy[id]);
										} else if (persons_intimacy[id] >= 20 && persons_intimacy[id] < 50) {
											InsertToRelation(person_core.group_id, id, relations[2], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else {
										if (persons_intimacy[id] >= 60) {
											if (person_core.age > persons_main[i].age) {
												InsertToRelation(person_core.group_id, id, relations[7], persons_intimacy[id]);
											} else {
												InsertToRelation(person_core.group_id, id, relations[6], persons_intimacy[id]);
											}
										} else if (persons_intimacy[id] >= 20 && persons_intimacy[id] < 60) {
											InsertToRelation(person_core.group_id, id, relations[2], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									}
								} else {
									if (Math.abs(persons_main[i].age - person_core.age) <= 3) {
										if (persons_intimacy[id] >= 20) {
											InsertToRelation(person_core.group_id, id, relations[1], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else if (Math.abs(persons_main[i].age - person_core.age) >= 23) {
										if (persons_intimacy[id] >= 60) {
											InsertToRelation(person_core.group_id, id, relations[6], persons_intimacy[id]);
										} else if (persons_intimacy[id] >= 50 && persons_intimacy[id] < 60) {
											InsertToRelation(person_core.group_id, id, relations[5], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else {
										InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
									}
								}
							} else {
								if (person_core.age > 20) {
									if (Math.abs(persons_main[i].age - person_core.age) <= 10) {
										if (persons_intimacy[id] >= 40) {
											if (person_core.gender == '男') {
												InsertToRelation(person_core.group_id, id, relations[3], persons_intimacy[id]);
											} else {
												InsertToRelation(person_core.group_id, id, relations[4], persons_intimacy[id]);
											}
										} else if (persons_intimacy[id] >= 20 && persons_intimacy[id] < 40) {
											InsertToRelation(person_core.group_id, id, relations[2], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else if (Math.abs(persons_main[i].age - person_core.age) > 10 && Math.abs(persons_main[i].age -
											person_core.age) < 22) {
										if (persons_intimacy[id] >= 50) {
											InsertToRelation(person_core.group_id, id, relations[5], persons_intimacy[id]);
										} else if (persons_intimacy[id] >= 20 && persons_intimacy[id] < 50) {
											InsertToRelation(person_core.group_id, id, relations[2], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else {
										if (persons_intimacy[id] >= 60) {
											if (person_core.age > persons_main[i].age) {
												InsertToRelation(person_core.group_id, id, relations[7], persons_intimacy[id]);
											} else {
												InsertToRelation(person_core.group_id, id, relations[6], persons_intimacy[id]);
											}
										} else if (persons_intimacy[id] >= 20 && persons_intimacy[id] < 60) {
											InsertToRelation(person_core.group_id, id, relations[2], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									}
								} else {
									if (Math.abs(persons_main[i].age - person_core.age) <= 3) {
										if (persons_intimacy[id] >= 20) {
											InsertToRelation(person_core.group_id, id, relations[1], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else if (Math.abs(persons_main[i].age - person_core.age) >= 23) {
										if (persons_intimacy[id] >= 60) {
											InsertToRelation(person_core.group_id, id, relations[6], persons_intimacy[id]);
										} else if (persons_intimacy[id] >= 50 && persons_intimacy[id] < 60) {
											InsertToRelation(person_core.group_id, id, relations[5], persons_intimacy[id]);
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									} else {
										if (persons_intimacy[id] >= 40) {
											if (person_core.gender == '男') {
												InsertToRelation(person_core.group_id, id, relations[3], persons_intimacy[id]);
											} else {
												InsertToRelation(person_core.group_id, id, relations[4], persons_intimacy[id]);
											}
										} else {
											InsertToRelation(person_core.group_id, id, relations[0], persons_intimacy[id]);
										}
									}
								}
							}
							// }
						}

					}).catch(function(err) {
						console.log(err);
					})

					// 					let person_main = persons_main[i];
					// 					let age_diff = person_core.age - person_main
				}

			}).catch(function(error) {
				console.log(error);
			})
		}
		
		//绘制显示核心人物的人脉关系图
		function relationGraph(group_id) {
			var faceArr = [];
			var linkArr = [];
			var promiseArr = [];
			getGroupFaceById(group_id).then(function(e) {
				let core_face_src = e.rows.item(0).face_src;
				var core_person = {
					category: 0,
					name: '',
					value: 10,
					shapeType: 'image',
					onclick: function(params) {
						localStorage.setItem('id', group_id);
						mui.openWindow({
							url: 'person-images.html'
						})
					},
					itemStyle: {
						normal: {
							x: -30,
							y: -30,
							width: 80,
							height: 80,
							image: core_face_src,
// 							shadowBlur: 30, // 默认为0，阴影模糊度，大于0有效
// 							shadowColor: 'red'
						}
					}
				};
				faceArr.push(core_person);
			}).then(function() {
				getRelatedPerson(group_id).then(function(e) {
					for (let i = 0; i < e.rows.length; i++) {
						let person_main = e.rows.item(i).person_main;
						let person_relation = e.rows.item(i).person_relation;
						promiseArr.push(
							getGroupFaceById(person_main).then(function(res) {
								let main_face_src = res.rows.item(0).face_src;
								let main_face_info = res.rows.item(0).group_info;
								let k = relations.indexOf(person_relation) + 1;
								let j = i+1;
								var main_person = {
									category: k,
									name: main_face_info,
									value: 3,
									shapeType: 'image',
									onclick: function(params) {	
										var mod = localStorage.getItem('mod');
										if(mod == 1){
											modifyRelation(group_id, person_main, person_relation);
										}									
									},
									itemStyle: {
										normal: {
											x: -30,
											y: -30,
											width: 50,
											height: 50,
											image: main_face_src,
										}
									}
								};
								var main_link = {
									source: j,
									target: 0,
									weight: j
								}
								faceArr.push(main_person);
								linkArr.push(main_link);
								// console.log(faceArr.length);
								// console.log(JSON.stringify(faceArr));
							}).catch(function(err) {
								console.log(JSON.stringify(err));
							})
						)
					}
					Promise.all(promiseArr).then(function() {
						drawGraph(faceArr, linkArr);
						// console.log(JSON.stringify(faceArr));
					})
				});

			}).catch(function(err) {
				console.log(err);
			})
		}

		function drawGraph(faceArr, linkArr) {
			require.config({
				packages: [{
					name: 'echarts',
					location: '../echarts/src',
					main: 'echarts'
				}, {
					name: 'zrender',
					location: '../zrender/src',
					main: 'zrender'
				}]
			});

			var option = {
// 				title: {
// 					text: '人物关系：乔布斯',
// 					subtext: '数据来自人立方',
// 					x: 'right',
// 					y: 'bottom'
// 				},
				tooltip: {
					trigger: 'item',
					formatter: '{a} : {b}'
				},
				legend: {
					x: 'left',
					selected: {
						'朋友': true,
						'同学': true,
						'同事': true,
						'兄弟': true,
						'姐妹': true,
						'家人': true,
						'父母': true,
						'孩子': true,
						'爱人': true
					},
					data: ['朋友', '同学', '同事', '兄弟', '姐妹', '家人', '父母', '孩子', '爱人']
				},
				isShowScrollBar: false,
				series: [{
					type: 'kforce',
					categories: [{
							name: '人物',
							itemStyle: {
								normal: {
									shadowBlur: 80,
									shadowColor: 'black'
								}
							}
						},
						{
							name: '朋友',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									// shadowColor: '#007fff'
									shadowColor: '#e65c00'
								}
							}
						},
						{
							name: '同学',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#66e0ff'
								}
							}
						},
						{
							name: '同事',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#ff80df'
								}
							}
						},
						{
							name: '兄弟',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#80ff80'
								}
							}
						},
						{
							name: '姐妹',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#4d94ff'
								}
							}
						},
						{
							name: '家人',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#ff80aa'
								}
							}
						},
						{
							name: '父母',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#cc00cc'
								}
							}
						},
						{
							name: '孩子',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#ff1a1a'
								}
							}
						},
						{
							name: '爱人',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#ffd633'
								}
							}
						}
					],
					itemStyle: {
						normal: {
							label: {
								show: false,    //不显示名字
								textStyle: {
									color: '#000000'
								}
							},
							nodeStyle: {
								brushType: 'both',
								strokeColor: 'rgba(255,215,0,0.4)',
								lineWidth: 2
							}
						},
						emphasis: {
							linkStyle: {
								type: 'curve',
								// strokeColor: '#5182AB'
							}
						}
					},
					minRadius: 15,
					maxRadius: 25,
					density: 0.8,
					attractiveness: 0.8,
					roam: 'move',
					nodes: faceArr,
					links: linkArr
				}]
			};
			require(
				[
					'echarts',
					'echarts/chart/kforce',
				],
				function(ec) {
					var myChart = ec.init(document.getElementById('demo1'));
					myChart.setOption(option);
				}
			)
		}
		
		//修改人物间关系
		function modifyRelation(group_id, person_main, person_relation) {
			// e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
			var btnArray = ['取消', '确定'];
			mui.prompt('', '请输入关系', '关系：'+person_relation, btnArray, function(e) {
				if (e.index == 1) {
					var relation = '';
		            if(e.value == null || e.value == ''){
						relation = person_relation;
					}else{
						relation = e.value;
						var index = relations.indexOf(relation);
						if(index >= 0){
							relationGraph(group_id);
							UpdatePersonRelation(group_id, person_main, relation);
						}
						else{
							mui.toast('关系输入不正确');
							modifyRelation(group_id, person_main, person_relation);
						}
						
					}											
				}
			},'div');
		}
	</script>
</html>
