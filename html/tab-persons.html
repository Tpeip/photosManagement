<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			img {
				height: 70px;
				width: 70px;
				border-radius: 70px;
				margin-right: 3px;
			}

			#slider {
				height: 70px;
			}

			.mui-content-padded {
				margin-top: 20px;
			}

			.label-font {
				font-size: 16px;
				color: #6D6D72;
			}

			.icon-style {
				font-size: 20px;
				color: #0062CC;
				font-weight: bolder;
			}
		</style>
	</head>
	<body>
		<div class="mui-content">
			<img id="img" style="display:none" />
			<canvas id="can" style="display:none;width:200px;height:200px"></canvas>
			<div class="mui-content-padded">
				<div id="slider" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div id="img-faces" class="mui-scroll">
						<!-- <img src="images/12.png" onclick="turnTo()" />
						<img src="images/13.png" />
						<img src="images/14.jpg" />
						<img src="images/15.jpg" />
						<img src="images/12.png" />
						<img src="images/13.png" />
						<img src="images/14.jpg" />
						<img src="images/15.jpg" />
						<img id="more" src="images/more.png" /> -->
					</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<label class="mui-icon mui-icon-paperplane icon-style"></label>
				<label class="mui-tab-label label-font">人脉关系图</label>
				<a id="modify" class="mui-tab-label label-font mui-pull-right" style="color: #0062CC;">修改</a>
				<div id="main" style="height:500px;border-top:1px solid #ccc;margin-top:10px"></div>
			</div>
		</div>

	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/jquery.min.js"></script>
	<script src="../js/echarts.min.js"></script>
	<!-- <script src="../js/esl.js"></script> -->
	<script src="../js/websql.js"></script>
	<script src="../js/person.js"></script>
	<script type="text/javascript">
		// 			mui.init();
		// 			mui('#slider').scroll({
		// 				indicators: true
		// 			});
		var relations = ['朋友', '同学', '同事', '兄弟', '姐妹', '家人', '父母', '孩子', '爱人'];

		window.addEventListener('fresh', function() {
			// location.reload();
			getAllRelation();
			setFaceHtml();
			// 			var group_id = localStorage.getItem('id');
			// 			relationGraph(group_id);
		})

		mui.plusReady(function() {
			getAllRelation();
			//				getPersonGroup();
			// updateGroupFace();
			setFaceHtml();
		})

		var flag = 0;
		localStorage.setItem('mod', flag);
		document.getElementById('modify').addEventListener('tap', function() {
			if (flag == 0) {
				document.getElementById('modify').innerHTML = '取消修改';
				flag = 1;
				localStorage.setItem('mod', flag);
			} else {
				document.getElementById('modify').innerHTML = '修改';
				flag = 0;
				localStorage.setItem('mod', flag);
			}
		})



		//显示人物分组
		function setFaceHtml() {
			jQuery('#img-faces').empty();
			var length = $("#img-faces").children("img").length;
			// console.log(length);
			var html = '';
			getGroupFace().then(function(e) {
				// console.log(e.rows.length);
				// console.log(e.rows.item(0));
				var length = e.rows.length;
				// console.log(length);
				if (length == 0) {
					relationGraph("");
				} else {
					// console.log(length);
					var person_one = e.rows.item(0).group_id;
					relationGraph(person_one);
					for (let i = 0; i < length; i++) {
						let face_url = e.rows.item(i).face_src;
						let group_id = e.rows.item(i).group_id;
						// console.log(group_id);
						// console.log(face_url);
						var face_html = '<img src="' + face_url + '" onclick="turnTo(\'' + group_id + '\')" />'
						html += face_html;
					}
					html = html + '<img id="more" src="../images/more.png"  onclick="showPersons()"/>';
					jQuery('#img-faces').append(html);
				}

				// relationGraph(person_one);

			}).catch(function(e) {
				console.log(JSON.stringify(e));
			});

		}



		function turnTo(group_id) {
			// getPersonRelation(group_id);
			relationGraph(group_id);
		}

		function showPersons() {
			mui.openWindow({
				url: 'persons.html',
				show: {
					autoShow: true,
					aniShow: 'slide-in-right',
					duration: 300
				}
			});
		}

		// 		function getPersonRelation(group_id) {
		// 			localStorage.setItem('id', group_id);
		// 			// getPersonIntimacy(group_id);
		// 			// 			handleCorePerson(group_id);
		// 			// relationGraph(group_id);
		// 		}
		// 
		//绘制显示核心人物的人脉关系图
		function relationGraph(group_id) {
			var faceArr = [];
			var linkArr = [];
			var promiseArr = [];
			if (group_id == null || group_id == '') {
				drawGraph(faceArr, linkArr);
			} else {
				getGroupFaceById(group_id).then(function(e) {
					let core_face_src = e.rows.item(0).face_src;
					var core_person = {
						category: 0,
						name: '',
						symbol: 'image://' + core_face_src,
						symbolSize: [60, 60],
						value: 10,
						id: group_id,
// 						onclick: function(params) {
// 							localStorage.setItem('id', group_id);
// 							mui.openWindow({
// 								url: 'person-images.html'
// 							})
// 						},
						itemStyle: {
							normal: {
								x: -30,
								y: -30,
								width: 80,
								height: 80,
								image: core_face_src,
								// 							shadowBlur: 30, // 默认为0，阴影模糊度，大于0有效
								// 							shadowColor: 'red'
							}
						}
					};
					faceArr.push(core_person);
				}).then(function() {
					getRelatedPerson(group_id).then(function(e) {
						for (let i = 0; i < e.rows.length; i++) {
							let person_main = e.rows.item(i).person_main;
							let person_relation = e.rows.item(i).person_relation;
							promiseArr.push(
								getGroupFaceById(person_main).then(function(res) {
									let main_face_src = res.rows.item(0).face_src;
									let main_face_info = res.rows.item(0).group_info;
									let k = relations.indexOf(person_relation) + 1;
									let j = i + 1;
									var main_person = {
										category: k,
										name: main_face_info,
										symbol: 'image://' + main_face_src,
										symbolSize: [45, 45],
										value: 3,	
									    core_id: group_id,
										main_id: person_main,
										person_relation: person_relation										
									};
									var main_link = {
										source: j,
										target: 0,
										weight: j
									}
									faceArr.push(main_person);
									linkArr.push(main_link);
								}).catch(function(err) {
									console.log(JSON.stringify(err));
								})
							)
						}
						Promise.all(promiseArr).then(function() {
							drawGraph(faceArr, linkArr);
							// console.log(JSON.stringify(faceArr));
						})
					});

				}).catch(function(err) {
					console.log(err);
				})
			}

		}

		function drawGraph(faceArr, linkArr) {
			var myChart = echarts.init(document.getElementById('main'));			
			option = {
				tooltip: {
					trigger: 'item',
					formatter: function(param){
						let label = relations[param.data.category-1];
						let name = param.data.name;
						var text = label + ": " + name;
						if(name == null || name == ""){
							text = label;
						}
						return text;
					}
				},
				color: ['#b30000', '#ff9900', '#99cc00', '#4db8ff', '#b2b300', '#ff80bf', '#0044cc', '#b266ff', '#bf8040'],
				legend: {
					x: 'left',
					selected: {
						'朋友': true,
						'同学': true,
						'同事': true,
						'兄弟': true,
						'姐妹': true,
						'家人': true,
						'父母': true,
						'孩子': true,
						'爱人': true
					},					
					data: ['朋友', '同学', '同事', '兄弟', '姐妹', '家人', '父母', '孩子', '爱人']
				},
				series: [{
					type: 'graph',
					layout: 'force',
					symbolSize: 50,
					roam: 'move',
					// edgeSymbol: ['circle', ''],
					// edgeSymbolSize: [4, 10],
					// 							edgeSymbolSize: [4, 10],
					edgeLabel: {
						normal: {
							textStyle: {
								fontSize: 10
							}
						}
					},
					force: {
						repulsion: 2500,
						edgeLength: [10, 20]
					},
					draggable: true,
					ribbonType: false,
					name: '',
					categories: [{	
							name: '人物',
							itemStyle: {
								normal: {
									shadowBlur: 80,
									shadowColor: 'black'
								}
							}
						},
						{
							name: '朋友',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									// shadowColor: '#007fff'
									shadowColor: '#ff9900'
								}
							}
						},
						{
							name: '同学',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#99cc00'
								}
							}
						},
						{
							name: '同事',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '兄弟',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#b2b300'
								}
							}
						},
						{
							name: '姐妹',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#ff80bf'
								}
							}
						},
						{
							name: '家人',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#0044cc'
								}
							}
						},
						{
							name: '父母',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#b266ff'
								}
							}
						},
						{
							name: '孩子',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#bf8040'
								}
							}
						},
						{
							name: '爱人',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#b30000'
								}
							}
						}
					],
					itemStyle: {
						normal: {
							label: {
								show: false,
								textStyle: {
									color: '#333'
								}
							},
							nodeStyle: {
								brushType: 'both',
								borderColor: 'rgba(255,215,0,0.4)',
								borderWidth: 1
							},
							linkStyle: {
								type: 'curve'
							}
						},
						emphasis: {
							label: {
								show: false
								// textStyle: null      // 默认使用全局文本样式，详见TEXTSTYLE
							},
							nodeStyle: {
								//r: 30
							},
							linkStyle: {}
						}
					},
					useWorker: false,
					minRadius: 15,
					maxRadius: 25,
					gravity: 1.1,
					scaling: 1.1,
					roam: 'move',
					data: faceArr,
					links: linkArr
				}]
			};

			// 为echarts对象加载数据 
			myChart.setOption(option);
			myChart.on('click', function(param){
				var id = param.data.id;
				if(param.data.category == 0){
					localStorage.setItem('id', id);
					mui.openWindow({
						url: 'person-images.html'
					})
				}else{
					var mod = localStorage.getItem('mod');
					if (mod == 1) {
						let group_id = param.data.core_id;
						let person_main = param.data.main_id;
						let person_relation = param.data.person_relation;
						modifyRelation(group_id, person_main, person_relation);
					}
				}
			});
		}

		//修改人物间关系
		function modifyRelation(group_id, person_main, person_relation) {
			// e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
			var btnArray = ['取消', '确定'];
			mui.prompt('', '请输入关系', '关系：' + person_relation, btnArray, function(e) {
				if (e.index == 1) {
					var relation = '';
					if (e.value == null || e.value == '') {
						relation = person_relation;
					} else {
						relation = e.value;
						var index = relations.indexOf(relation);
						if (index >= 0) {
							relationGraph(group_id);
							UpdatePersonRelation(group_id, person_main, relation);
						} else {
							mui.toast('关系输入不正确');
							modifyRelation(group_id, person_main, person_relation);
						}

					}
				}
			}, 'div');
		}
	</script>
</html>
