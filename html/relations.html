<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<style type="text/css">
			img {
				height: 70px;
				width: 70px;
				border-radius: 70px;
				margin-right: 3px;
			}

			#slider {
				height: 70px;
			}

			.mui-content-padded {
				margin-top: 20px;
			}

			.label-font {
				font-size: 16px;
				color: #6D6D72;
			}

			.icon-style {
				font-size: 20px;
				color: #0062CC;
				font-weight: bolder;
			}
		</style>
	</head>
	<body>
		<div class="mui-content">
			<img id="img" style="display:none" />
			<canvas id="can" style="display:none;width:200px;height:200px"></canvas>
			<div class="mui-content-padded">
				<div id="slider" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div id="img-faces" class="mui-scroll">
						<!-- <img src="images/12.png" onclick="turnTo()" />
						<img src="images/13.png" />
						<img src="images/14.jpg" />
						<img src="images/15.jpg" />
						<img src="images/12.png" />
						<img src="images/13.png" />
						<img src="images/14.jpg" />
						<img src="images/15.jpg" />
						<img id="more" src="images/more.png" /> -->
					</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<label class="mui-icon mui-icon-paperplane icon-style"></label>
				<label class="mui-tab-label label-font">人脉关系图</label>
				<a id="modify" class="mui-tab-label label-font mui-pull-right" style="color: #0062CC;">修改</a>
				<div id="main" style="height:500px;width: 350px; border-top:1px solid #ccc;margin-top:10px"></div>
			</div>
		</div>

	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/jquery.min.js"></script>
	<script src="../js/echarts.min.js"></script>
	<script src="../js/mui.picker.js"></script>
	<script src="../js/mui.poppicker.js"></script>
	<script src="../js/esl.js"></script>
	<script src="../js/websql.js"></script>
	<script src="../js/person.js"></script>
	<script type="text/javascript">
		mui.init();
		var relations = ['朋友', '同学', '同事', '兄弟', '姐妹', '家人', '父母', '孩子', '爱人'];
		var flag = 0;
		localStorage.setItem('mod', flag);
		var visited = [];
		var personArr = [];
		var lineArr = [];

		//监听页面刷新
		window.addEventListener('fresh', function() {
			// location.reload();
			getAllRelation();
			setFaceHtml();
		});

		mui.plusReady(function() {
			getAllRelation();
			setFaceHtml();
		})

		//判断人物关系修改状态		
		document.getElementById('modify').addEventListener('tap', function() {
			if (flag == 0) {
				document.getElementById('modify').innerHTML = '取消修改';
				flag = 1;
				localStorage.setItem('mod', flag);
			} else {
				document.getElementById('modify').innerHTML = '修改';
				flag = 0;
				localStorage.setItem('mod', flag);
			}
		})

		//显示人物分组
		function setFaceHtml() {
			jQuery('#img-faces').empty();
			var length = $("#img-faces").children("img").length;
			var html = '';
			getGroupFace().then(function(e) {
				var length = e.rows.length;
				if (length == 0) {
					showOneRelation("");
				} else {
					var person_one = e.rows.item(0).group_id;
					showAllRelation();
					for (let i = 0; i < length; i++) {
						let face_url = e.rows.item(i).face_src;
						let group_id = e.rows.item(i).group_id;
						var face_html = '<img src="' + face_url + '" onclick="turnTo(\'' + group_id + '\')" />'
						html += face_html;
					}
					html = html + '<img id="more" src="../images/more.png"  onclick="showPersons()"/>';
					jQuery('#img-faces').append(html);
				}
			}).catch(function(e) {
				console.log(JSON.stringify(e));
			});

		}

		//显示核心人物的相关照片
		function showPersons() {
			mui.openWindow({
				url: 'persons.html',
				show: {
					autoShow: true,
					aniShow: 'slide-in-right',
					duration: 300
				}
			});
		}

		function turnTo(group_id) {
			showOneRelation(group_id);
		}
		//显示核心人物的人脉关系图
		function showOneRelation(group_id) {
			// console.log(group_id);
			var faceArr = [];
			var linkArr = [];
			if (group_id == null || group_id == '') {
				drawOneGraph(faceArr, linkArr);
			} else {
				let id = group_id;
				let key = allPerson.findIndex(function(x) {
					return x.group_id == id;
				});
				let core_face_src = allPerson[key].face_src;
				let core_group_info = allPerson[key].group_info;
				let persons = allPerson[key].persons;
				let core_person = {
					category: 0,
					name: core_group_info,
					value: 10,
					shapeType: 'image',
					onclick: function(params) {
						localStorage.setItem('id', group_id);
						mui.openWindow({
							url: 'person-images.html'
						})
					},
					itemStyle: {
						normal: {
							x: -30,
							y: -30,
							width: 70,
							height: 70,
							image: getImgData(core_face_src)
						}
					}
				};
				faceArr.push(core_person);
				if (persons.length > 0) {
					for (let i = 0; i < persons.length; i++) {
						let person_id = persons[i].id;
						// console.log(person_id);
						let person_relation = persons[i].relation;
						let index = relations.indexOf(person_relation) + 1;
						let k = allPerson.findIndex(function(x) {
							return x.group_id == person_id;
						});
						// 						console.log(k);
						// 						console.log(allPerson[k].group_info);
						let info = allPerson[k].group_info;
						let main_face_src = allPerson[k].face_src;
						let main_person = {
							category: index,
							name: info,
							value: 10,
							shapeType: 'image',
							onclick: function(params) {
								var mod = localStorage.getItem('mod');
								if (mod == 1) {
									modifyRelation(group_id, person_id, person_relation);
								}
							},
							itemStyle: {
								normal: {
									x: -20,
									y: -20,
									width: 50,
									height: 50,
									image: getImgData(main_face_src)
								}
							}
						};
						faceArr.push(main_person);
						let j = i + 1;
						var main_link = {
							source: j,
							target: 0,
							weight: j
						};
						linkArr.push(main_link);
					}
				}
				drawOneGraph(faceArr, linkArr);
			}
		}

		//绘制单个人物的人脉关系图
		function drawOneGraph(faceArr, linkArr) {
			require.config({
				packages: [{
					name: 'echarts',
					location: '../echarts/src',
					main: 'echarts'
				}, {
					name: 'zrender',
					location: '../zrender/src',
					main: 'zrender'
				}]
			});
			var option = {
				tooltip: {
					trigger: 'item',
					formatter: '{a} : {b}'
				},
				color: ['#ff9900', '#99cc00', '#4db8ff', '#b2b300', '#ff80bf', '#0044cc', '#b266ff', '#bf8040', '#b30000'],
				legend: {
					x: 'left',
					selected: {
						'朋友': true,
						'同学': true,
						'同事': true,
						'兄弟': true,
						'姐妹': true,
						'家人': true,
						'父母': true,
						'孩子': true,
						'爱人': true
					},
					data: ['朋友', '同学', '同事', '兄弟', '姐妹', '家人', '父母', '孩子', '爱人']
				},
				isShowScrollBar: false,
				series: [{
					type: 'kforce',
					categories: [{
							name: '人物',
							itemStyle: {
								normal: {
									shadowBlur: 80,
									shadowColor: 'black'
								}
							}
						},
						{
							name: '朋友',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									// shadowColor: '#007fff'
									shadowColor: '#ff9900'
								}
							}
						},
						{
							name: '同学',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#99cc00'
								}
							}
						},
						{
							name: '同事',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '兄弟',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#b2b300'
								}
							}
						},
						{
							name: '姐妹',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#ff80bf'
								}
							}
						},
						{
							name: '家人',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#0044cc'
								}
							}
						},
						{
							name: '父母',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#b266ff'
								}
							}
						},
						{
							name: '孩子',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#bf8040'
								}
							}
						},
						{
							name: '爱人',
							itemStyle: {
								normal: {
									shadowBlur: 50,
									shadowColor: '#b30000'
								}
							}
						}
					],
					itemStyle: {
						normal: {
							label: {
								show: false, //不显示名字
								textStyle: {
									color: '#000000'
								}
							},
							nodeStyle: {
								brushType: 'both',
								strokeColor: 'rgba(255,215,0,0.4)',
								lineWidth: 2
							},
							lineStyle: {
								normal: {
									show: true,
									color: 'target'
								}
							}
						},
						emphasis: {
							linkStyle: {
								type: 'curve',
							}
						}
					},
					lineStyle: {
						normal: {
							width: 1,
							color: '#4b565b'
						}
					},
					minRadius: 15,
					maxRadius: 25,
					density: 0.8,
					attractiveness: 0.8,
					roam: 'move',
					nodes: faceArr,
					links: linkArr
				}]
			};
			require(
				[
					'echarts',
					'echarts/chart/kforce',
				],
				function(ec) {
					var myChart = ec.init(document.getElementById('main'));
					myChart.setOption(option);
				}
			)
		}


		//修改人物间关系
		function modifyRelation(group_id, person_main, person_relation) {
			// e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
			// 			var btnArray = ['取消', '确定'];
			// 			mui.prompt('', '请输入关系', '关系：' + person_relation, btnArray, function(e) {
			// 				if (e.index == 1) {
			// 					var relation = '';
			// 					if (e.value == null || e.value == '') {
			// 						relation = person_relation;
			// 					} else {
			// 						relation = e.value;
			// 						var index = relations.indexOf(relation);
			// 						if (index >= 0) {
			// 							relationGraph(group_id);
			// 							UpdatePersonRelation(group_id, person_main, relation);
			// 						} else {
			// 							mui.toast('关系输入不正确');
			// 							modifyRelation(group_id, person_main, person_relation);
			// 						}
			// 
			// 					}
			// 				}
			// 			}, 'div');
			// var btnArray = ['取消', '确认'];
			// 			var html = '';
			// 			for(let i=0; i<relations.length; i++){
			// 				if((i+1)%3 == 0){
			// 					let htmlone = '<input type="radio" value=">'+relations[i]+'"/>'+relations[i]+'<br>';
			// 					// let htmlone = '<button class="mui-btn" value="'+relations[i]+'" style="height:20px;line-height:10px;margin:0px 10px 5px 10px">'+relations[i]+'</button><br/>';
			// 					html += htmlone;
			// 				}else{
			// 					let htmlone = '<input type="radio" value=">'+relations[i]+'"/>'+relations[i];
			// 					// let htmlone = '<button class="mui-btn" value="'+relations[i]+'" style="height:20px;line-height:10px;margin:0px 10px 5px 10px">'+relations[i]+'</button>';
			// 					html += htmlone;
			// 				}					
			// 			}
			// var html = '<select>'+
			// 						'<option value="朋友">朋友</option>'+
			// 						'<option value="同学">同学</option>'+
			// 						'<option value="同事">同事</option>'+
			// 						'</select>';

			// 			mui.confirm(html,  '关系：' + person_relation, btnArray, function(e) {
			// 				if (e.index == 1) {
			// 					console.log('你刚确认MUI是个好框架');
			// 				} else {
			// 					console.log('123');
			// 				}
			// 			},'div');
			var userPicker = new mui.PopPicker();
			userPicker.setData([{
				value: '朋友',
				text: '朋友'
			}, {
				value: '同学',
				text: '同学'
			}, {
				value: '同事',
				text: '同事'
			}, {
				value: '兄弟',
				text: '兄弟'
			}, {
				value: '姐妹',
				text: '姐妹'
			}, {
				value: '家人',
				text: '家人'
			}, {
				value: '父母',
				text: '父母'
			}, {
				value: '孩子',
				text: '孩子'
			}, {
				value: '爱人',
				text: '爱人'
			}]);
			var relation = person_relation;
			userPicker.show(function(items) {
				// console.log(JSON.stringify(items[0])) ;
				relation = items[0].value;
				UpdateOneRelation(group_id, person_main, relation);
				//返回 false 可以阻止选择框的关闭
				//return false;
			});
		}

		//更新数据库人物关系
		function UpdateOneRelation(group_id, person_main, relation) {
			let id = group_id;
			// console.log(group_id);
			let key = allPerson.findIndex(function(x) {
				return x.group_id == group_id;
			});
			let persons = allPerson[key].persons;
			let k = persons.findIndex(function(e) {
				return e.id == person_main;
			});
			allPerson[key].persons[k].relation = relation;
			// console.log(allPerson[key].persons[k].relation);
			showOneRelation(id);
			UpdatePersonRelation(group_id, person_main, relation);
		}

		//显示总人脉关系图
		function showAllRelation() {
			var promiseArr = [];
			getPersonData().then(function() {
				for (let i = 0; i < allPerson.length; i++) {
					let group_id = allPerson[i].group_id;
					let core_face_src = allPerson[i].face_src;
					let group_info = allPerson[i].group_info;
					if (visited.indexOf(group_id) < 0) {
						promiseArr.push(
							wideTraversal(group_id, core_face_src, i)
						);
					}
				}
				Promise.all(promiseArr).then(function() {
					// console.log(visited);
					// console.log(JSON.stringify(lineArr));
					drawAllGraph(personArr, lineArr);
				});
			})
		}
		

		//遍历一个人的人脉关系
		function wideTraversal(core_person, core_face_src, pos) {
			var promiseArr = [];
			var proArr = [];
			let persons = allPerson[pos].persons;
			if (persons.length == 0) {
				visited.push(core_person);
				let core_person_node = {
					category: 0,
					name: '',
					symbol: 'image://' + getImgData(core_face_src),
					symbolSize: [50, 50],
					value: 10,
					person: core_person,
					src: core_face_src,
					pos: pos
				};
				personArr.push(core_person_node);
			} else {
				let queue = [];
				queue.unshift(core_person);
				visited.push(core_person);
				let core_person_node = {
					category: 0,
					name: '',
					symbol: 'image://' + getImgData(core_face_src),
					symbolSize: [50, 50],
					value: 10,
					person: core_person,
					src: core_face_src,
					pos: pos
				};
				personArr.push(core_person_node);
				while (queue.length > 0) {
					// console.log(queue.length);
					let core = queue.shift();
					let key = allPerson.findIndex(function(x) {
						return x.group_id == core;
					});
					let len = allPerson[key].persons.length;
					for (let i = 0; i < len; i++) {
						let main_person = allPerson[key].persons[i].id;
						let relation = allPerson[key].persons[i].relation;
						let index = relations.indexOf(relation) + 1;
						let main_key = allPerson.findIndex(function(x) {
							return x.group_id == main_person;
						});
						if (visited.indexOf(main_person) < 0) {

							let main_face_src = allPerson[main_key].face_src;
							queue.push(main_person);
							visited.push(main_person);
							let main_person_node = {
								category: index,
								name: '',
								symbol: 'image://' + getImgData(main_face_src),
								symbolSize: [50, 50],
								value: 10,
								person: main_person,
								src: main_face_src,
								pos: main_key
							};
							personArr.push(main_person_node);

						}
						let target_value = visited.indexOf(core);
						let source_value = visited.indexOf(main_person);
						let line = {
							source: source_value,
							target: target_value
						};
						let k = lineArr.findIndex(function(e) {
							return line.source == e.target && line.target == e.source;
						});
						if (k < 0) {
							line.name = relation;
							lineArr.push(line);
						}

					}
				}
			}
		}

		//绘制总人脉关系图
		function drawAllGraph(faceArr, linkArr) {
			var myChart = echarts.init(document.getElementById('main'));
			var option = {
				title: {
					text: '人脉关系图'
				},
				tooltip: {
					trigger: 'item',
					formatter: '{a} : {b}'
				},
				isShowScrollBar: false,
				series: [{
					type: 'graph',
					layout: 'force',
					symbolSize: 80,
					roam: 'move',
					// edgeSymbol: ['circle', 'arrow'],
					edgeSymbolSize: [4, 10],
					edgeLabel: {
						normal: {
							textStyle: {
								fontSize: 10
							}
						}
					},
					force: {
						repulsion: 1000,
						edgeLength: [120, 150]
					},
					draggable: true,
					name: "",
					ribbonType: false,
					categories: [{
							name: '人物',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '朋友',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '同学',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '同事',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '兄弟',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '姐妹',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '家人',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '父母',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '孩子',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						},
						{
							name: '爱人',
							itemStyle: {
								normal: {
									shadowBlur: 40,
									shadowColor: '#4db8ff'
								}
							}
						}
					],
					itemStyle: {
						normal: {
							label: {
								show: false,
								textStyle: {
									color: '#333'
								}
							},
							nodeStyle: {
								brushType: 'both',
								borderColor: 'rgba(255,215,0,0.4)',
								borderWidth: 1
							},
							linkStyle: {
								type: 'curve'
							}
						},
						emphasis: {
							label: {
								show: false
								// textStyle: null      // 默认使用全局文本样式，详见TEXTSTYLE
							},
							nodeStyle: {
								//r: 30
							},
							linkStyle: {}
						}
					},
					lineStyle: {
						normal: {
							width: 1,
							color: '#4b565b'
						}
					},
					edgeLabel: {
						normal: {
							show: true,
							formatter: function(x) {
								if (x.data.name)
									return x.data.name;
							}
						}
					},
					useWorker: false,
					minRadius: 15,
					maxRadius: 25,
					gravity: 0.1,
					scaling: 0.1,
					roam: 'move',
					data: faceArr,
					links: linkArr
				}]
			};

			// 为echarts对象加载数据 
			myChart.setOption(option);
			myChart.on('click', function(param) {
				var id = param.data.person;
				var src = param.data.src;
				var pos = param.data.pos;
				showOneRelation(id);
				// wideTraversal(id, src, pos);
			});
		}
	</script>
</html>
